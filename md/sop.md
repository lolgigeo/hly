# 章节处理标准操作程序（SOP）

## 文档说明

本文档基于第01、02章的成功处理经验，总结出标准化的章节处理流程和规范，用于指导后续章节的校对和Markdown生成工作。

## 一、处理流程概览

```
原始文件(hl.txt, GBK) 
  ↓ [阶段1: 文本清理]
清理后文件(hl_cleaned.txt, UTF-8)
  ↓ [阶段2: 章节分析]
章节配置(chapters_config.json)
  ↓ [阶段3: 批量提取]
原始章节(chapters_raw/chapter_XX.txt)
  ↓ [阶段4: 单个章节处理]
最终Markdown(result/第XX章.md)
```

## 二、阶段1：文本清理

### 2.1 目标
- 移除论坛格式信息
- 规范化编码（GBK → UTF-8）
- 清理多余空白和换行

### 2.2 执行脚本
```bash
python3 clean_text.py
```

### 2.3 清理规则

#### 2.3.1 论坛信息移除
- **匹配模式**：`级别:.*?最后登录:\d+.*?(?=第\d+回|$)`
- **移除内容**：
  - 用户级别信息（`级别:`）
  - 发帖信息（`发帖:`、`Posted:`）
  - 楼层标记（`[XX 楼]`）
  - 用户属性（`堂中威望`、`贡献值`、`注册时间`、`最后登录`）
  - 特殊标识（`梦中的王子`）

#### 2.3.2 空白规范化
- 统一换行符：`\r\n` → `\n`
- 移除行尾空白
- 合并连续空行：最多保留2个空行

#### 2.3.3 章节标记预处理
- 确保章节标记前后有适当空行
- 规范化章节标记格式

### 2.4 输出
- **文件**：`hl_cleaned.txt`
- **编码**：UTF-8
- **用途**：作为后续处理的输入文件

## 三、阶段2：章节分析

### 3.1 目标
- 识别所有章节位置
- 统一章节编号
- 生成章节配置文件

### 3.2 执行脚本
```bash
python3 analyze_chapters.py
```

### 3.3 章节识别规则

#### 3.3.1 章节标记格式
支持以下格式的章节标记：
- `第X回`（阿拉伯数字）
- `第XX回`（两位数）
- `第X章`（阿拉伯数字）
- `第XX章`（两位数）
- `第X回`（中文数字，如"三十九"、"一百"）

#### 3.3.2 编号统一规则
- 所有章节统一转换为阿拉伯数字编号（1-100）
- 中文数字转换为阿拉伯数字
- 生成统一的章节配置

### 3.4 输出
- **文件1**：`chapters_config.json` - 章节位置配置
- **文件2**：`chapter_analysis_report.md` - 分析报告

### 3.5 配置格式示例
```json
{
  "1": {
    "number": 1,
    "original": "第01回",
    "pattern_type": "阿拉伯数字+回",
    "start_line": 1,
    "end_line": 50
  }
}
```

## 四、阶段3：批量提取章节

### 4.1 目标
- 从清理后的文件中提取各章节原始内容
- 保存为独立文件供后续处理

### 4.2 执行脚本
```bash
python3 extract_chapters.py
```

### 4.3 提取规则
- 根据`chapters_config.json`中的行号范围提取
- 每个章节保存为`chapters_raw/chapter_XX.txt`
- 缺失章节生成空文件或占位文件

### 4.4 输出
- **目录**：`chapters_raw/`
- **文件格式**：`chapter_01.txt`、`chapter_02.txt`...`chapter_100.txt`

## 五、阶段4：单个章节处理（核心流程）

### 5.1 处理原则
**重要**：单个章节的校对和Markdown生成需要逐个进行，不能批量自动化处理，以确保质量。

### 5.2 处理流程

#### 步骤1：读取章节原始内容
```python
# 从chapters_raw目录读取
content = read_chapter_content(chapter_num, 'chapters_raw')
```

#### 步骤2：内容清理和格式化

##### 2.1 移除章节标记行
- **规则**：跳过包含当前章节标记的行（如"第03回"）
- **处理**：如果行中包含其他章节标记，停止处理（遇到下一章）

##### 2.2 移除论坛信息
- **匹配模式**：
  ```
  级别:|发帖:|Posted:|\[.*楼\]|堂中威望|贡献值|注册时间|最后登录|梦中的王子
  ```
- **处理**：只在章节开头移除，正文中的论坛信息需要人工判断

##### 2.3 移除副标题
- **识别模式**：`^[^。，！？]*[（(].*?[）)]$` 且长度 < 50
- **示例**：
  - `香车秘戏（红楼遗秘之王熙凤）` ✓ 移除
  - `龙阳奇趣(原红楼遗秘之秦锺)` ✓ 移除
  - `销魂小屋(原红楼遗秘之诛邪6)` ✓ 移除

##### 2.4 处理副标题与正文同行的情况
- **识别模式**：`^([^。，！？]*[（(].*?[）)])\s+(.+)$`
- **处理**：提取正文部分，跳过副标题

##### 2.5 移除章节标记混入正文
- **规则**：移除正文中的"第二章"、"第10回"等标记
- **处理**：使用正则替换：`第[0-9一二三四五六七八九十百]+[回章]\s*`

##### 2.6 移除特殊字符
- 移除单独的`?`号
- 移除行首的`?`号
- 移除"窗体底端"等无关文本

#### 步骤3：段落格式化

##### 3.1 段落识别规则
- **段落边界**：空行分隔
- **段落合并**：如果一行不以句号、问号、感叹号结尾，且下一行不是空行，则合并

##### 3.2 段落间距规范
- **标准格式**：段落之间使用**一个空行**分隔
- **避免**：多个连续空行（最多保留一个）

##### 3.3 段落优化示例
```python
# 合并被错误分割的段落
if last_char in '。！？' and len(line) > 10:
    # 开始新段落
else:
    # 合并到当前段落
```

#### 步骤4：生成Markdown

##### 4.1 标题格式
```markdown
# 第X章
```
- **统一格式**：`# 第X章`（X为阿拉伯数字）
- **编号规则**：不补零（第1章，不是第01章）

##### 4.2 正文格式
- 标题后空一行
- 段落之间空一行
- 保持原文的段落结构

##### 4.3 输出文件
- **目录**：`result/`
- **文件名**：`第01章.md`、`第02章.md`...`第100章.md`
- **编码**：UTF-8

### 5.3 质量检查清单

处理完成后，检查以下项目：

- [ ] **标题格式**：是否为`# 第X章`格式
- [ ] **副标题移除**：是否已移除所有副标题
- [ ] **章节标记**：正文中是否还有章节标记残留
- [ ] **论坛信息**：是否已清理论坛元数据
- [ ] **段落格式**：段落间距是否统一（一个空行）
- [ ] **特殊字符**：是否已移除`?`、"窗体底端"等
- [ ] **编码正确**：文件是否为UTF-8编码
- [ ] **内容完整**：章节内容是否完整，无截断

### 5.4 参考标准

#### 标准格式示例（第01章）
```markdown
# 第1章

可卿张开眼睛，仍就慵懒懒地躺着，回味起昨夜的风情，不觉嫣然甜笑，直至耳闻窗外鸟鸣声声，方恋恋不舍地从被窝里悄悄爬起来，不想被贾蓉一把拉住，懒声道："小东西，这么早起床，哪儿去？"

可卿复转回被窝，趴于夫君胸上，呢声道："园子里的梅花开了，今早得陪太太过去西府那边，请老祖宗和几位夫人过来赏花哩。"贾蓉皱眉道："怎么老有这种花哨事，改天再去请吧，你只陪着你相公。"可卿玉颊轻晕，尖尖的玉指轻揉着男人的乳头，娇声道："太太昨天就跟我说好啦……这叫花哨事么？小心给太太听见。"
```

#### 关键特征
1. ✅ 标题格式：`# 第1章`（不是`# 第01章`）
2. ✅ 标题后空一行
3. ✅ 段落之间空一行
4. ✅ 无副标题
5. ✅ 无章节标记混入
6. ✅ 无论坛信息
7. ✅ 段落完整，无错误分割

## 六、常见问题处理

### 6.1 论坛信息与章节标题在同一行

**问题**：
```
级别: 品色嘉宾精华: 8 发帖: 4963... 第07回 请君入瓮(原红楼遗秘之诛邪3) 正文...
```

**处理**：
1. 移除论坛信息：`级别:.*?注册时间.*?最后登录.*?\s*`
2. 移除章节标记：`第[0-9一二三四五六七八九十百]+[回章]\s*`
3. 处理副标题：提取副标题后的正文部分

### 6.2 副标题与正文在同一行

**问题**：
```
香车秘戏（红楼遗秘之王熙凤） 这日，宁国府贾珍夫人尤氏派人请凤姐过去玩...
```

**处理**：
- 使用正则：`^([^。，！？]*[（(].*?[）)])\s+(.+)$`
- 提取group(2)作为正文，跳过group(1)副标题

### 6.3 章节标记混入正文

**问题**：
```
...凤姐儿便拉着宝玉的手下车去了。 第二章却说贾政生辰之日...
```

**处理**：
- 移除：`第二章\s+` → 空字符串
- 确保段落分隔正确

### 6.4 章节内容为空

**问题**：某些章节提取后内容为空

**处理**：
- 检查原始文件是否有该章节
- 如果确实缺失，生成占位文件：
  ```markdown
  # 第XX章
  
  本章节在原文档中缺失。
  ```
- 在`progress.json`中标记为`skipped`

## 七、实际处理中的问题与解决方案（基于100章处理经验）

### 7.1 中文数字章节标记支持

**问题**：部分章节使用中文数字标记（如"第十六回"、"第十九章"、"第二十章"）

**解决方案**：
1. 实现中文数字到阿拉伯数字的转换函数
2. 支持1-100的所有中文数字表示
3. 在章节识别时统一转换为阿拉伯数字

**代码实现**：
```python
def chinese_to_arabic(chinese_num):
    """将中文数字转换为阿拉伯数字"""
    chinese_digits = {
        '一': 1, '二': 2, ..., '一百': 100
    }
    return chinese_digits.get(chinese_num, None)

def normalize_chapter_number(chapter_str):
    """标准化章节号"""
    if chapter_str.isdigit():
        return int(chapter_str)
    return chinese_to_arabic(chapter_str)
```

**应用位置**：在`format_chapter_content_sop`函数中，所有章节标记识别处都使用`normalize_chapter_number`进行标准化。

---

### 7.2 无括号副标题的处理

**问题**：部分章节的副标题没有括号（如"温柔仙乡"、"绝代魔姬"），与正文在同一行

**原始格式**：
```
第十九章　温柔仙乡 不知道过了多久，众丫鬟皆已衣裳不整...
```

**解决方案**：
1. 识别格式：`^([^。，！？]{2,10})\s+(.+)$`
2. 判断条件：副标题部分 ≤ 10字符，正文部分 > 20字符
3. 提取正文部分，移除副标题

**代码实现**：
```python
simple_subtitle_match = re.match(r'^([^。，！？]{2,10})\s+(.+)$', remaining)
if simple_subtitle_match:
    subtitle_part = simple_subtitle_match.group(1)
    body_part = simple_subtitle_match.group(2)
    if len(subtitle_part) <= 10 and len(body_part) > 20:
        remaining = body_part.strip()
```

**应用位置**：在论坛信息处理和章节标记处理中，都需要处理无括号副标题。

---

### 7.3 日期格式残留清理

**问题**：部分章节开头有日期格式残留（如":2010-06-05"）

**原始格式**：
```
级别: ... 最后登录:2010-06-05 	? 第十九章　温柔仙乡 ...
```

**解决方案**：
1. 添加日期格式清理规则：`re.sub(r':\d{4}-\d{2}-\d{2}\s*', '', text)`
2. 在多个处理阶段都进行日期清理
3. 在最终合并文本后再次清理

**应用位置**：
- 论坛信息处理阶段
- 章节标记处理阶段
- 最终文本合并后

---

### 7.4 章节标记混入正文的彻底清理

**问题**：正文中可能包含其他章节的标记（如"第二章"），单次清理可能遗漏

**解决方案**：
1. 在单行处理时清理章节标记
2. **关键**：在合并所有行后，再次使用正则表达式清理整个文本
3. 确保在段落格式化之前完成清理

**代码实现**：
```python
# 第一次清理（单行处理时）
remaining = re.sub(r'第[0-9一二三四五六七八九十百]+[回章]\s*', '', stripped)

# 第二次清理（合并文本后）
full_text = ' '.join(filtered)
full_text = re.sub(r'第[0-9一二三四五六七八九十百]+[回章]\s*', '', full_text)
```

**教训**：章节标记清理需要多次进行，确保无遗漏。

---

### 7.5 第一行特殊处理

**问题**：某些章节的第一行没有明确的章节标记，但有副标题和正文

**原始格式**：
```
香车秘戏（红楼遗秘之王熙凤） 这日，宁国府贾珍夫人尤氏派人请凤姐过去玩...
```

**解决方案**：
1. 检测第一行且未开始处理的情况
2. 处理副标题与正文同行的情况
3. 提取正文部分，移除副标题

**代码实现**：
```python
if i == 0 and not start_processing:
    start_processing = True
    # 处理副标题与正文同行的情况
    subtitle_match = re.match(r'^([^。，！？]*[（(].*?[）)])\s+(.+)$', stripped)
    if subtitle_match:
        body_text = subtitle_match.group(2).strip()
        # 清理和添加
```

**教训**：边界情况（第一行、最后一行）需要特殊处理。

---

### 7.6 缺失章节的识别和处理

**问题**：某些章节在原文档中缺失（第17、22、23、32、88、90、91章）

**识别方法**：
1. 文件大小 < 100字节
2. 只包含论坛信息，无章节标记
3. 无实际正文内容

**解决方案**：
1. 在处理前检查文件大小和内容
2. 如果识别为缺失章节，生成占位文件
3. 占位文件格式：
   ```markdown
   # 第XX章
   
   本章节在原文档中缺失。
   ```

**代码实现**：
```python
if len(content.strip()) < 100 and re.search(r'Posted:|\[.*楼\]|梦中的王子', content) and not re.search(r'第([0-9一二三四五六七八九十百]+)[回章]', content):
    return generate_placeholder(chapter_num)
```

---

### 7.7 段落格式化的参数调整

**问题**：段落分割不合理，有的段落过短，有的过长

**解决方案**：
1. 参考第01、02章的段落格式
2. 调整段落分割参数：
   - 当前段落长度 > 100字符
   - 下一句长度 > 20字符
3. 根据实际效果微调参数

**代码实现**：
```python
if len(next_sentence) > 20 and len(current_para_text) > 100:
    para_text = ' '.join(current_para)
    if para_text.strip():
        paragraphs.append(para_text.strip())
    current_para = []
```

**教训**：段落格式化参数需要根据实际效果调整，以标准章节为参考。

---

### 7.8 批量处理策略

**问题**：一次性处理所有章节可能导致批量错误，难以定位问题

**解决方案**：
1. **分批处理**：每批处理10个章节
2. **质量检查**：每批完成后进行质量检查
3. **及时修正**：发现问题及时修正，避免批量错误
4. **参考对比**：每批完成后与参考标准章节对比

**处理流程**：
```
批次1（11-20章） → 质量检查 → 修正问题
批次2（21-30章） → 质量检查 → 修正问题
...
批次9（91-100章） → 质量检查 → 最终验证
```

**教训**：分批处理便于质量控制，发现问题及时修正。

---

## 八、进度管理

### 7.1 进度文件格式
```json
{
  "1": {
    "status": "completed",
    "created_at": "2026-02-06T10:00:00",
    "updated_at": "2026-02-06T10:05:00",
    "notes": "已完成格式校对和Markdown生成"
  },
  "2": {
    "status": "pending",
    "created_at": null,
    "updated_at": null,
    "notes": null
  }
}
```

### 7.2 状态说明
- `pending`：待处理
- `processing`：处理中
- `completed`：已完成
- `skipped`：跳过（缺失章节）

### 7.3 批量处理脚本
```bash
# 处理指定范围的章节
python3 process_chapters_batch.py 3 10
```

## 八、优化后处理流程

### 8.1 优化脚本使用

对于第03-10章的优化处理，使用以下Python脚本：

```python
def optimize_chapter_v3(chapter_num):
    """
    优化章节格式，参考第01、02章的标准格式
    """
    # 1. 读取已生成的Markdown文件
    # 2. 移除副标题（单独行或与正文同行）
    # 3. 移除章节标记混入
    # 4. 统一段落格式
    # 5. 写回文件
```

### 8.2 优化检查项

- [ ] 副标题已移除
- [ ] 章节标记已清理
- [ ] 段落格式统一
- [ ] 与第01、02章格式一致

## 九、技术规范

### 9.1 编码规范
- **输入**：GBK编码（`hl.txt`）
- **处理**：UTF-8编码（所有中间文件）
- **输出**：UTF-8编码（`result/*.md`）

### 9.2 正则表达式模式

#### 章节标记识别
```python
r'第([0-9一二三四五六七八九十百]+)[回章]'
```

#### 论坛信息识别
```python
r'级别:|发帖:|Posted:|\[.*楼\]|堂中威望|贡献值|注册时间|最后登录|梦中的王子'
```

#### 副标题识别
```python
# 单独行
r'^[^。，！？]*[（(].*?[）)]$'  # 长度 < 50

# 与正文同行
r'^([^。，！？]*[（(].*?[）)])\s+(.+)$'
```

### 9.3 文件命名规范
- **原始章节**：`chapter_01.txt`（补零）
- **最终输出**：`第1章.md`（不补零）

## 十、质量保证

### 10.1 处理前后对比

**处理前**（chapters_raw/chapter_03.txt）：
```
级别: 品色嘉宾精华: 8 发帖: 4963... 第03回 香车秘戏（红楼遗秘之王熙凤） 这日，宁国府...
```

**处理后**（result/第03章.md）：
```markdown
# 第3章

这日，宁国府贾珍夫人尤氏派人请凤姐过去玩。凤姐梳洗完了，先回王夫人毕，方来辞贾母...
```

### 10.2 质量标准

1. **格式一致性**：所有章节格式与第01、02章一致
2. **内容完整性**：无内容丢失或截断
3. **编码正确性**：UTF-8编码，无乱码
4. **结构规范性**：标题、段落格式符合Markdown规范

## 十一、执行建议

### 11.1 处理顺序
1. 先处理第01、02章作为参考标准
2. 批量处理第03-10章
3. 逐个检查并优化
4. 按顺序继续处理后续章节

### 11.2 质量控制
- 每处理10个章节，进行一次格式检查
- 与第01、02章对比，确保格式一致
- 发现问题及时修正

### 11.3 工具使用
- **批量提取**：使用`extract_chapters.py`
- **批量处理**：使用`process_chapters_batch.py`
- **格式优化**：使用优化脚本（参考第03-10章的处理）

## 十二、附录

### 12.1 相关文件
- `clean_text.py` - 文本清理脚本
- `analyze_chapters.py` - 章节分析脚本
- `extract_chapters.py` - 批量提取脚本
- `process_chapters_batch.py` - 批量处理脚本
- `chapters_config.json` - 章节配置文件
- `progress.json` - 处理进度文件

### 12.2 目录结构
```
hly/
├── hl.txt                    # 原始文件（GBK）
├── hl_cleaned.txt            # 清理后文件（UTF-8）
├── chapters_config.json      # 章节配置
├── progress.json             # 处理进度
├── chapters_raw/             # 原始章节内容
│   ├── chapter_01.txt
│   └── ...
├── result/                   # 最终输出
│   ├── 第01章.md
│   └── ...
└── md/
    ├── plan.md               # 执行计划
    └── sop.md                # 本文档
```

---

**文档版本**：v2.0  
**最后更新**：2026-02-06  
**基于章节**：第01-100章完整处理经验  
**相关文档**：
- `md/experience.md` - 经验总结与教训
- `md/plan.md` - 执行计划
- `md/process_chapters_reusable.py` - 可复用处理脚本
